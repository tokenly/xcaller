// Generated by CoffeeScript 1.10.0

/*
 *
 * Calls notifications to subscribed clients
 *
 */

(function() {
  var COUNT, NOTIFICATIONS_OUT_TUBE, beanstalkHost, beanstalkPort, client, fivebeans, href;

  beanstalkHost = process.env.BEANSTALK_HOST || '127.0.0.1';

  beanstalkPort = process.env.BEANSTALK_PORT || 11300;

  NOTIFICATIONS_OUT_TUBE = process.env.NOTIFICATIONS_OUT_TUBE || 'notifications_out';

  COUNT = process.env.COUNT || 20;

  fivebeans = require('fivebeans');

  href = "http://127.0.0.1:8099/index.php";

  client = new fivebeans.client(beanstalkHost, beanstalkPort);

  client.on('connect', function() {
    return client.use(NOTIFICATIONS_OUT_TUBE, function(err, tubename) {
      var i, j, payload, ref;
      for (i = j = 0, ref = COUNT; 0 <= ref ? j < ref : j > ref; i = 0 <= ref ? ++j : --j) {
        payload = {
          meta: {
            id: 1000 + i,
            attempt: 0,
            endpoint: href,
            returnTubeName: 'notifications_return'
          },
          payload: JSON.stringify({
            name: "Job " + (i + 1),
            ts: Date.now(),
            foo: 'bar'
          })
        };
        client.put(10, 0, 300, JSON.stringify(payload), function(err, jobid) {
          if (err) {
            console.log("err: " + err);
          }
          return console.log("put job " + jobid);
        });
      }
      return client.end();
    });
  });

  client.connect();

}).call(this);
